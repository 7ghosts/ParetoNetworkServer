<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>P A R E T O .</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Place favicon.ico in the root directory -->
        <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
        <link rel="manifest" href="manifest.json">
        <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
        <meta name="theme-color" content="#ffffff">

       

        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <link href="static/css/open-iconic-bootstrap.css" rel="stylesheet">

       

        <style type="text/css">

        #pareto-content_wrapper.dataTables_wrapper table thead{
           display:none;
        }

        #my-posts_wrapper.dataTables_wrapper table thead{
           display:none;
        }

        .content-borders {
            border: 1px solid #d3d3d3;
        }

        </style>

         <!-- this has to load after bootstrap and inline css, a tragedy -->
        <link rel="stylesheet" href="static/css/general.css">
        <link rel="stylesheet" href="static/css/custom.css">

    </head>
    <body style="overflow: scroll; background: #fff">
        <div style="position: fixed; width: 100%; z-index: 999;">
        	<div id="gradient" class="row" style="vertical-align: top;
        		height: 5px; 
        		background: #295087; /* Old browsers */
    			background: -moz-linear-gradient(left, #295087 0%, #3f7989 50%, #6aba82 77%, #85c568 100%); /* FF3.6-15 */
    			background: -webkit-linear-gradient(left, #295087 0%,#3f7989 50%,#6aba82 77%,#85c568 100%); /* Chrome10-25,Safari5.1-6 */
    			background: linear-gradient(to right, #295087 0%,#3f7989 50%,#6aba82 77%,#85c568 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
    			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#295087', endColorstr='#85c568',GradientType=1 ); /* IE6-9 */
                ">&nbsp;</div>

            <nav class="navbar navbar-expand-md font-body" style="background-color: #040f1e; color: #ffffff;">
              <div class="container-fluid">
                <div class="navbar-header">
                  <a class="navbar-brand" href="/"><img src="static/images/LogoReverse.svg" class="header-img" width="150" style="opacity: 100;"/></a>
                </div>
                <button class="navbar-toggler navbar-dark" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div id="navbarNavDropdown" class="navbar-collapse collapse" style="flex-grow: unset; font-weight: bold; /*polyfill because something is broken in the navbar-collapse class*/">
                    <ul class="navbar-nav mr-auto" id="navbar-links">
                        <li class="nav-item">
                            <a class="nav-link nav-bar-link" href="/dashboard">Intel</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-bar-link" href="/rank">Leaderboards</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-bar-link" href="/about">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              <span class="oi oi-person text-truncate"></span><span id="nav-user-access"></span> 
                            </a>
                            <div class="dropdown-menu" id="navbar-dropdown" aria-labelledby="navbarDropdownMenuLink" style="font-size: 11px; right: 0; left: auto;">
                             <!-- <button id="access-sign" type="button" class="btn btn-info" style="background-color:rgb(107, 194, 123); height:35px; font-size:14px; opacity:0" onClick="sign()">Access</button>  -->
                                <span class="dropdown-item" id="dropdown-user-address"></span>
                                <a href="#" id="access" class="dropdown-item dropdown-menu-link" onClick="logout()" style="color: #000;">Logout</a>
                            </div>
                        </li>
                    </ul>
                </div>
              </div>
            </nav>
        </div>

        <div class="container" style="min-height: 100vh; padding-top:120px; color: #000;">
            <div class="row" style="padding-left: 10px; padding-right: 10px;">
                <div class="col-md-4" style="margin-bottom: 5px;">

                    <!-- user management cells -->
                    <div style="margin-right: 5px;">
                        <!-- imagine there are two cells, one for profile pic and edit profile, the other for user details -->
                        <div id="address-details" class="row content-borders font-body" style="font-size: 12px; padding-left: 5px; padding-right: 5px; overflow: hidden;">
                            <div class="col-4">
                                <div class="content-borders" style="margin: 5px; display: block; text-align: center; overflow: hidden; width:60px; height:60px;">
                                    <span style="font-size: 50px; padding: 5px; color: gray; background: #b2b2b2; width:100%; height:100%;" class="oi oi-person"></span>
                                </div>
                            </div>

                            <div class="col-8" style="padding-top:5px;">
                                
                                <div id="address-alias" class="text-truncate" style="font-weight: bold; font-size: 14px;"></div>
                                <div id="address-balance-holder" style="display: inline-block;"><img src="static/images/LogoMarkColor.svg" style="float:left;" width="20"/><div id="address-balance" style="float:left;"></div></div> <!-- set HTML w/ the icon size and all concatenation -->
                                <div id="address-score" style="color: grey;"></div>

                                <!-- <div id="address-stat"></div> --><!--use this cell to show improvements in stats, OR optional Bio -->
                                
                            </div>
                        </div>

                        <br />
                        <br />
                        <br />
                    </div>


                    <!-- <div class="content-borders" style="font-size: 12px; padding: 5px;">
                        <div style="font-size: 12px; color: #a3a3a3; padding-left: 10px; padding-top: 10px;">LEADERBOARD</div>
                        <table id="pareto-leaderboard" class="table font-body" style="width:90%">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>

                        </table>
                    </div> -->
                    <div style="width: 100%">
                        <div class="content-borders" id="my-posts-holder" style="font-size: 12px; padding: 5px; height: 50vh;">
                            <div style="font-size: 12px; color: #a3a3a3; padding-left: 10px; padding-top: 10px;">MY POSTS</div>
                                <table id="my-posts" class="table font-body" style="width:100%"></table>
                        </div>
                    </div>

                </div>

                <div class="col-md-1">
                    &nbsp; <!-- spacer lol -->
                </div>

                <div class="col-md-7"  style="padding-right: 5px; padding-left: 5px;">
                    <!-- my intel feed, add user management elements later -->
                    <div id="intel-feed" class="content-borders" style="margin-bottom: 10px;"> 

                        <div style="font-size: 12px; color: #a3a3a3; padding-left: 10px; padding-top: 10px;">MY INTEL FEED</div>

                        <!-- throw in data table, and then supplement with vue.js later -->
                        <table id="pareto-content" class="table font-body" style="width:90%"></table>

                    </div>
                </div> 
            </div>

        </div>

        <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script>

    </body>
    <script src="static/js/bundle.js"></script>
    <script>

        var lookupInput = $("#lookup-input");


        function sign(){
            let event = new Event("sign");
            window.dispatchEvent(event);
        }

        function logout(){
           let event = new Event("revert");
           window.dispatchEvent(event); 
        }

        window.addEventListener('content', function (e){
          
          if($.fn.dataTable.isDataTable( '#pareto-content' )){
                table.destroy();
          }

          table = $('#pareto-content').DataTable({
                        responsive: true,
                        searching: false, 
                        paging: false, 
                        ordering: false, 
                        info: false,
                        ajax: {
                            url: '/v1/content'/*+'?rank='+rank+'&limit='+limit+'&page='+page*/,
                            dataSrc: ''
                        },
                        columnDefs: [ 
                            { 
                                targets: 0, 
                                data : 'body', 
                                render : function ( data, type, row ) {
                                    var alias = '';
                                    if(row.alias !== undefined){
                                        alias = "(" + row.alias + ")";
                                    }

                                     return '<b>'+row.title+'</b><br/>'+'<div style="font-size: 12px;">Disclosed by: '+row.address + alias + ' at block ' + row.block + '</div><br/>' + row.body; 
                                 } //end function 
                            }
                        ],
                        language: {
                            emptyTable: "A higher score is needed to view currently disclosed intel, check back momentarily"
                        }/*,
                        columns: [
                            { 
                                data : 'body'
                            }
                        ]*/
                    });

        });

        window.addEventListener('revert', function(){
            //var accessValue = $("#access-toggle").value;
            //if(accessValue === "Disconnect"){

                //clear cookie and clear dashboard view and go back to access view

                 $.ajax({
                      method: 'POST',
                      url: '/v1/unsign',
                      body: {},
                      dataType: 'json',
                      success: function (data, textStatus, jqXHR) {

                        //if here then user authenticated, could also return address/user information.
                        $("#access-toggle").value = "Access";
                        console.log("no signature");

                        //push to homepage
                        window.location.replace("/");

                      },
                      error: function (jqXHR, textStatus, errorThrown) {
                        console.log(errorThrown);
                      }
                  });
            /*} else {
                $("#access-toggle").value = "Disconnect";
                //sign
                //let event = new Event("sign");
                //window.dispatchEvent(event);

            }*/

        });

        $(document).ready(function() {

            
          $.ajax({
                method: 'GET',
                url: '/v1/auth',
                dataType: 'json',
                success: function (data, textStatus, jqXHR) {

                  //if here then user authenticated, could also return address/user information.

                  $('#nav-user-access').html("&nbsp;"+data.auth.substring(0, 10)+"...&nbsp;");
                  $('#dropdown-user-address').html(data.auth);

                  //set address or alias to input field and set it to read-only
                  window.dispatchEvent(new CustomEvent("address", { }));
                  window.dispatchEvent(new CustomEvent("content", { }));
                  window.dispatchEvent(new CustomEvent("my-posts", { }));
                     $.fn.dataTableExt.errMode = 'ignore';

                },
                error: function (jqXHR, textStatus, errorThrown) {
                  
                  console.log(errorThrown);
                  
                  window.location.replace("/");


                }
            }); //end ajax

            window.dispatchEvent(new CustomEvent("leaderboard", { 'detail' : { rank : 1, limit : 100, page: 0}}));

        });

        function revert(){
            let event = new Event("revert");
            window.dispatchEvent(event);
        };

        window.addEventListener('address', function(e){
             $.ajax({
                method: 'GET',
                url: '/v1/address',
                dataType: 'json',
                success: function (data, textStatus, jqXHR) {

                    //set address info to localStorage maybe.

                    //display address info in profile cell

                    /* data that is available
                    {
                        "_id": "5aa8bafabb2fc932b37959d4",
                        "address": "0x1cd35769e5e5e03493dc532bddd0d94f5a8723b2",
                        "block": 5383677,
                        "score": 16772.878023478403,
                        "rank": 3365,
                        "tokens": 0
                    }
                    */

                    $('#address-alias').html(data.address);
                    $('#address-balance').html("&nbsp;" + data.tokens + "&nbsp;PARETO");
                    if(data.tokens <= 0){
                        //run web3 count algo
                    }
                    $('#address-score').html("Network Rank " + data.rank/*Number(data.score).toFixed(5)*/);


                },
                error: function (jqXHR, textStatus, errorThrown) {

                }
            }); //end ajax
        });

        window.addEventListener('leaderboard', function (e){

          var rank = e.detail.rank;
          var limit = e.detail.limit;
          var page = e.detail.page;
          
          if($.fn.dataTable.isDataTable( '#pareto-leaderboard' )){
                table.destroy();
          }

          table = $('#pareto-leaderboard').DataTable({
                        searching: false, 
                        paging: false, 
                        ordering: false, 
                        info: false,
                        scrollY: "70vh",
                        scrollCollapse : false,
                        ajax: {
                            url: '/v1/rank?rank='+rank+'&limit='+limit+'&page='+page,
                            dataSrc: ''
                        },
                        columns: [
                            { data : 'rank'},
                            { 
                                data : 'score',
                                render: $.fn.dataTable.render.number( ',', '.', 2)
                            }
                        ]
                    });

        });

        window.addEventListener('my-posts', function (e){
          
          if($.fn.dataTable.isDataTable( '#my-posts' )){
                table.destroy();
          }

          table = $('#my-posts').DataTable({
                        responsive: true,
                        searching: false, 
                        paging: false, 
                        ordering: false, 
                        info: false,
                        ajax: {
                            url: '/v1/content/me',
                            dataSrc: ''
                        },
                        columnDefs: [ 
                            { 
                                targets: 0, 
                                data : 'body', 
                                render : function ( data, type, row ) {
                                    var alias = '';
                                    if(row.alias !== undefined){
                                        alias = "(" + row.alias + ")";
                                    }

                                     return '<b>'+row.title+'</b><br/>'+'<div style="font-size: 12px;">Disclosed by: '+row.address + alias + ' at block ' + row.block + '</div><br/>' + row.body; 
                                 } //end function 
                            }
                        ],
                        language: {
                            emptyTable: "No data to display"
                        }
                    });

        });

    </script>

    
    
</html>